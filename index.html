<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8" />

        <title>SR Tablet Interface</title>

        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

        <script src="bower_components/platform/platform.js"></script>
        <script src="bower_components/moment/moment.js"></script>

        <link rel="icon" href="images/icon.png" />

        <link rel="stylesheet" href="bower_components/components-font-awesome/css/font-awesome.css" />
        <link rel="stylesheet" href="bower_components/normalize-css/normalize.css" />
        <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Lato:300,400,700/Inconsolata:500" />
        <link rel="stylesheet" href="styles/common.css" />

        <link rel="import" href="elements/core/sr-battery.html" />
        <link rel="import" href="elements/core/sr-button-bar.html" />
        <link rel="import" href="elements/core/sr-fa-button.html" />
        <link rel="import" href="elements/core/sr-navigation-drawer.html" />
        <link rel="import" href="elements/pages/page-battery.html" />
        <link rel="import" href="elements/pages/page-camera.html" />
        <link rel="import" href="elements/pages/page-io.html" />
        <link rel="import" href="elements/pages/page-log.html" />
        <link rel="import" href="elements/pages/page-motors.html" />
        <link rel="import" href="elements/pages/page-servos.html" />
        <link rel="import" href="elements/pages/page-setup.html" />
    </head>

    <body fullbleed unresolved horizontal layout>
        <sr-button-bar>
            <sr-fa-button action="toggle-navigation-drawer" icon="bars"></sr-fa-button>
            <sr-fa-button action="play" icon="play"></sr-fa-button>
            <div flex></div>
            <sr-battery></sr-battery>
        </sr-button-bar>

        <sr-navigation-drawer pages="#pages">
            <sr-fa-button action="setup" icon="cogs">Set up</sr-fa-button>
            <sr-fa-button action="log" icon="file-text-o">Log</sr-fa-button>
            <div flex style="min-height: 25px;"></div>
            <sr-fa-button action="battery" icon="bolt">Battery</sr-fa-button>
            <sr-fa-button action="camera" icon="camera">Camera</sr-fa-button>
            <sr-fa-button action="io" icon="file">I/O</sr-fa-button>
            <sr-fa-button action="motors" icon="arrows">Motors</sr-fa-button>
            <sr-fa-button action="servos" icon="wrench">Servos</sr-fa-button>
            <div flex style="min-height: 25px;"></div>
            <sr-fa-button action="play" icon="play">Start Robot</sr-fa-button>
            <sr-fa-button action="install" icon="download">Install</sr-fa-button>
            <!-- <sr-fa-button icon="question" onclick="window.open('https://www.studentrobotics.org/docs/')">Docs</sr-fa-button> -->
        </sr-navigation-drawer>

        <sr-pages flex>
            <page-setup id="page-setup"></page-setup>
            <page-log hidden></page-log>
            <page-battery hidden></page-battery>
            <page-camera hidden></page-camera>
            <page-io hidden></page-io>
            <page-motors hidden></page-motors>
            <page-servos hidden></page-servos>
        </sr-pages>

        <core-ajax
            id="ajax-start"
            url="/start"
            handleAs="json"></core-ajax>

        <core-ajax
            id="ajax-stop"
            url="/stop"
            handleAs="json"></core-ajax>

        <core-ajax
            id="ajax-state"
            url="/state"
            handleAs="json"></core-ajax>

        <script>
            (function() {
                window.addEventListener("toggle-navigation-drawer", function(e) {
                    document.querySelector("sr-navigation-drawer").toggle();
                });
            }());
        </script>

        <script>
            window.addEventListener("polymer-ready", function() {
                var srPages = document.querySelector("sr-pages");
                var srNavigationDrawer = document.querySelector("sr-navigation-drawer");
                var pages = ["setup", "log", "battery", "camera", "io", "motors", "servos"];
                for (var i in pages) {  // why? seriously, just why?
                    (function(page) {
                        window.addEventListener(page, function() {
                            console.log(page);
                            srPages.changePage(page);
                            srNavigationDrawer.close();
                        });
                    }(pages[i]));
                }
            });
        </script>

        <script>
            window.addEventListener("install", function(e) {
                // https://bugzilla.mozilla.org/show_bug.cgi?id=745928 :D
                var manifestUrl = location.protocol + "//" + location.host + "/manifest.webapp";
                var request = window.navigator.mozApps.install(manifestUrl);
                request.onsuccess = function() {
                    document.querySelector("#navigation").close();
                    console.log(this);
                };
                request.onerror = function() {
                    alert(this.error);
                };
            });
        </script>

        <script>
            window.addEventListener("polymer-ready", function() {
                var btns = document.querySelectorAll("sr-fa-button[action='play']");
                var changeIcon = function(icon) {
                    for (var i = 0; i < btns.length; i++) {
                        btns[i].icon = icon;
                    }
                };
                var changeText = function(text) {
                    for (var i = 0; i < btns.length; i++) {
                        if (btns[i].textContent.length !== 0) {
                            btns[i].textContent = text;
                        }
                    }
                };

                window.addEventListener("play", function(e) {
                    console.log(e.detail);
                    if (e.detail.button.icon == "play") {
                        changeIcon("cog fa-spin");
                        changeText("Starting…");
                        document.querySelector("#page-setup").disabled = true;
                        document.querySelector("#ajax-start").go();
                    } else {
                        changeIcon("cog fa-spin");
                        changeText("Stopping…");
                        document.querySelector("#ajax-stop").go();
                    }
                });

                var ajaxState = document.querySelector("#ajax-state");
                ajaxState.addEventListener("core-response", function(e) {
                    var state = e.target.response.state;
                    if (state === "started") {
                        changeIcon("stop");
                        changeText("Stop Robot");
                    } else if (state === "stopped") {
                        changeIcon("play");
                        changeText("Start Robot");
                    } else if (state === "booting") {
                        changeIcon("cog fa-spin");
                        changeText("Starting…");
                    } else if (state === "stopping") {
                        changeIcon("cog fa-spin");
                        changeText("Stopping…");
                    }
                });

                ajaxState.go();
                setInterval(ajaxState.go.bind(ajaxState), 1000);
            });
        </script>
    </body>

</html>
