<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />

    <title>Student Robotics Robot Interface</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <link rel="icon" href="images/icon.png" />

    <link rel="stylesheet" href="bower_components/components-font-awesome/css/font-awesome.css" />
    <link rel="stylesheet" href="styles/common.css" />

    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>

    <link rel="import" href="bower_components/iron-pages/iron-pages.html" />

    <link rel="import" href="components/sr-ui-button-bar/sr-ui-button-bar.html" />
    <link rel="import" href="components/sr-ui-fa-button/sr-ui-fa-button.html" />
    <link rel="import" href="components/sr-ui-navigation-drawer/sr-ui-navigation-drawer.html" />
    <link rel="import" href="components/sr-wamp-status-indicator/sr-wamp-status-indicator.html" />
    <link rel="import" href="components/sr-wamp/sr-wamp.html" />
    <link rel="import" href="components/sr-wamp-procedure/sr-wamp-procedure.html" />
    <link rel="import" href="components/sr-wamp-subscribe/sr-wamp-subscribe.html" />

    <link rel="import" href="components/sr-camera-page/sr-camera-page.html" />
    <link rel="import" href="components/sr-io-page/sr-io-page.html" />
    <link rel="import" href="components/sr-logs-page/sr-logs-page.html" />
    <link rel="import" href="components/sr-motors-page/sr-motors-page.html" />
    <link rel="import" href="components/sr-power-page/sr-power-page.html" />
    <link rel="import" href="components/sr-servos-page/sr-servos-page.html" />
    <link rel="import" href="components/sr-setup-page/sr-setup-page.html" />
  </head>

  <body>
    <sr-ui-button-bar>
      <sr-ui-fa-button action="toggle-navigation-drawer" icon="bars"></sr-ui-fa-button>
      <div style="height: 20px;"></div>
      <sr-ui-fa-button action="play" icon="play"></sr-ui-fa-button>
    </sr-ui-button-bar>

    <sr-ui-navigation-drawer id="drawer">
      <sr-ui-fa-button action="change-page" data-page="0" icon="cogs">Set up</sr-ui-fa-button>
      <sr-ui-fa-button action="change-page" data-page="1" icon="file-text-o">Logs</sr-ui-fa-button>
      <div style="height: 30px;"></div>
    </sr-ui-navigation-drawer>

    <iron-pages id="pages" selected="0" style="display: flex; flex: 1 1 auto;">
      <sr-setup-page></sr-setup-page>
      <sr-logs-page></sr-logs-page>
    </iron-pages>

    <sr-wamp-status-indicator style="position: fixed; right: 0; bottom: 0;"></sr-wamp-status-indicator>

    <sr-wamp id="wamp"></sr-wamp>
    <sr-wamp-procedure id="wamp-start" name="org.srobo.start"></sr-wamp-procedure>
    <sr-wamp-procedure id="wamp-stop" name="org.srobo.stop"></sr-wamp-procedure>
    <sr-wamp-subscribe id="wamp-sub-state" auto="wamp" topic="org.srobo.state"></sr-wamp-subscribe>
    <sr-wamp-procedure id="wamp-call-state" name="org.srobo.state"></sr-wamp-procedure>

    <script>
      (function() {
        window.addEventListener("toggle-navigation-drawer", function(e) {
          document.querySelector("sr-ui-navigation-drawer").toggle();
        });

        window.addEventListener("change-page", function(e) {
          document.querySelector("#pages").select(e.detail.sender.dataset.page);
          document.querySelector("sr-ui-navigation-drawer").close();
        });
      }());
    </script>

    <script>
      window.addEventListener("play", function(e) {
        if (e.detail.sender.icon == "play") {
          document.querySelector("#wamp-start").go();
        } else if (e.detail.sender.icon == "stop") {
          document.querySelector("#wamp-stop").go();
        }
      });
    </script>

    <script>
      (function() {
        var wamp = document.querySelector("sr-wamp");

        wamp.addEventListener("open", function() {
          wamp.call('org.srobo.hello', ['0.1.0']).then(function(result) {
            if (!result['compatible']) {
              window.location.reload();
            }
          }.bind(this));

          var btns = document.querySelectorAll("[action='play']");
          for (var i = 0; i < btns.length; i++) {
            btns[i].hidden = false;
          }
        });

        wamp.addEventListener("close", function() {
          var btns = document.querySelectorAll("[action='play']");
          for (var i = 0; i < btns.length; i++) {
            btns[i].hidden = true;
          }
        });
      }());
    </script>

    <script>
      var btns = document.querySelectorAll("[action='play']");
      var changeIcon = function(icon) {
        for (var i = 0; i < btns.length; i++) {
          btns[i].icon = icon;
        }
      };

      var loadCustomPages = function() {
        console.log("Loading custom pagesâ€¦");
        var userCodeUrl = "http://" + location.hostname + ":5080/user";
        var xhr = new XMLHttpRequest();
        xhr.open("GET", userCodeUrl + "/pages");
        xhr.responseType = "json";
        xhr.addEventListener("load", function(e) {
          var pages = e.target.response.pages;
          console.log("Got some custom pages:", pages);

          var currentPageIndex = 2;  // number of built-in pages
          pages.forEach(function(page) {
            Polymer.Base.importHref(userCodeUrl + page.import_url, function(e) {
              // success
              var pageElement = document.createElement(page.name);
              pageElement.dataset.custom = true;
              Polymer.dom(document.querySelector("#pages")).appendChild(pageElement);

              var btn = document.createElement('sr-ui-fa-button');
              btn.setAttribute('icon', 'cubes');
              Polymer.dom(btn).textContent = page.title;
              btn.setAttribute('action', 'change-page');
              btn.dataset.page = currentPageIndex;
              btn.dataset.custom = true;
              Polymer.dom(document.querySelector("#drawer")).appendChild(btn);

              currentPageIndex += 1;
            }, function(e) {
              // error
            });
          });
        });
        xhr.send();
      };

      var removeCustomPages = function() {
        var customElements = document.querySelectorAll("[data-custom=true]");
        for (var i = 0; i < customElements.length; i++) {
          customElements[i].parentNode.removeChild(customElements[i]);
        }
      };

      var handleState = function(e) {
        var state = e.detail.result || e.detail.args[0];
        if (state === "started") {
          changeIcon("stop");

          setTimeout(function() {
            loadCustomPages();
          }, 1000);  // time for HTTP server to start
        } else if (state === "stopped") {
          changeIcon("play");
          removeCustomPages();
        } else if (state === "booting") {
          changeIcon("cog fa-spin");
        } else if (state === "stopping") {
          changeIcon("cog fa-spin");
          removeCustomPages();
        }
      };

      document.querySelector("sr-wamp").addEventListener("open", function() {
        document.querySelector("#wamp-call-state").go();
      });
      document.querySelector("#wamp-sub-state").addEventListener("handle", handleState);
      document.querySelector("#wamp-call-state").addEventListener("success", handleState);
    </script>
  </body>

</html>
