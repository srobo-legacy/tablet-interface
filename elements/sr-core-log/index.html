<link rel="import" href="/bower_components/polymer/polymer.html" />

<polymer-element name="sr-core-log">
    <template>
        <style>
            :host {
                display: flex;
            }

            #log {
                flex: 1 1 auto;
                resize: none;
                box-sizing: border-box;
                font-family: "Inconsolata", monospace;
            }
        </style>

        <textarea id="log" readonly></textarea>

        <sr-core-wamp
            on-open="{{handleOpen}}"></sr-core-wamp>
        <sr-core-wamp-subscribe
            topic="org.srobo.log"
            on-handle="{{handleLog}}"></sr-core-wamp-subscribe>
        <sr-core-wamp-call
            id="call"
            procedure="org.srobo.log"
            on-success="{{handleLog}}"></sr-core-wamp-call>
    </template>

    <script>
        Polymer("sr-core-log", {
            handleOpen: function() {
                this.$.call.go();
            },
            isAtBottom: function() {
                var log = this.$.log;
                return Math.abs((log.scrollTop + log.clientHeight) - log.scrollHeight) <= 10;
            },
            scrollToBottom: function() {
                var log = this.$.log;
                log.scrollTop = log.scrollHeight;
            },
            addEntry: function(text, addDate) {
                if (addDate === undefined) {
                    addDate = true;
                }

                var isAtBottom = this.isAtBottom();

                if (addDate) {
                    var date = moment().format("HH:mm:ss");
                    this.$.log.innerHTML += date + ": ";
                }

                this.$.log.innerHTML += text + "\n";

                if (isAtBottom) {
                    this.scrollToBottom();
                }
            },
            handleLog: function(e) {
                if (e.detail.result !== undefined) {
                    var text = e.detail.result.trim();
                    if (text.length > 0) {
                        this.addEntry("-- Previous Log Starts Here --");
                        this.addEntry(text, false);
                        this.addEntry("-- Previous Log Ends Here --");
                        this.scrollToBottom();
                    }
                } else {
                    this.addEntry(e.detail.args[0]);
                }
            }
        });
    </script>
</polymer-element>
