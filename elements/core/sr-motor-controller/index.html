<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="../sr-wamp/index.html" />

<polymer-element name="sr-motor-controller" attributes="board motor value">
    <script src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script src="/bower_components/aterrien/jQuery-Knob/dist/jquery.knob.min.js"></script>

    <template>
        <style>
            :host {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            h2 {
                margin: 2px 0;
            }

            div {
                margin: 32px 0;
            }
        </style>

        <h2>{{motor}}</h2>
        <input id="value" type="text" value="{{value}}" on-change="{{handleValueChange}}" />

        <sr-wamp-subscribe
            topic="org.srobo.motors.value"
            on-handle="{{handleValue}}"></sr-wamp-subscribe>
        <sr-wamp-publish
            id="publishValue"
            topic="org.srobo.motors.value"></sr-wamp-publish>
    </template>

    <script>
        Polymer("sr-motor-controller", {
            board: 0,
            motor: 0,
            value: 0,
            domReady: function() {
                $(this.$.value).knob({
                    min: -100,
                    max: 100,
                    step: 0.01,
                    angleOffset: -125,
                    angleArc: 250,
                    displayPrevious: true,
                    release: function(v) {
                        this.value = v;
                        this.handleValueChange();
                    }.bind(this)
                });
            },
            handleValueChange: function() {
                this.$.publishValue.go([this.board, this.motor, parseFloat(this.value)]);
            },
            handleValue: function(e) {
                if (e.detail.args[0] === this.board && e.detail.args[1] === this.motor) {
                    this.value = parseFloat(e.detail.args[2]);
                }
            },
            formatValue: function(v) {
                return Number(v).toFixed(2);
            }
        });
    </script>
</polymer-element>
