<!--
`sr-logs-logs` provides an entire collection of logs.

Example:

    <sr-logs-logs></sr-logs-logs>

@group SR Logs Elements
@element sr-logs-logs
-->

<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="/bower_components/core-localstorage/core-localstorage.html" />
<link rel="import" href="../ui/index.html" />
<link rel="import" href="../wamp/index.html" />
<link rel="import" href="index.html" />

<polymer-element name="sr-logs-logs">
    <template>
        <style>
            :host {
                flex: 1 1 auto;
                display: flex;
            }

            #logs {
                display: flex;
                flex: 1 1 auto;
            }
        </style>

        <div id="logs">

        </div>

        <core-localstorage
            id="localStorage"
            name="logs"></core-localstorage>

        <sr-wamp-core
            on-open="{{ handleWampOpen }}"
            on-close="{{ handleWampClose }}"></sr-wamp-core>
        <sr-wamp-call
            id="wampOldLogsCall"
            procedure="org.srobo.logs.all"
            on-success="{{ handleAllLogs }}"></sr-wamp-call>
    </template>

    <script>
        Polymer("sr-logs-logs", {
            handleWampOpen: function() {
                this.$.wampOldLogsCall.go();
            },
            _createLogElement: function(log) {
                var element = document.createElement("sr-logs-log");
                element.id = "log_" + log.name;
                element.log = log.name;
                element.hidden = true;
                return element;
            },
            handleWampClose: function() {
                this.$.localStorage.value.forEach(function(log) {
                    var element = this._createLogElement(log);
                    this.$.logs.appendChild(element);
                    this.fire("add", log);
                }.bind(this));

                this.changeTo("current");
            },
            handleAllLogs: function(e) {
                this.$.localStorage.value = [];

                e.detail.result.forEach(function(log) {
                    var element = this._createLogElement(log);
                    this.$.logs.appendChild(element);

                    this.$.localStorage.value.push({
                        "type": log["type"],
                        "name": log["name"],
                        "title": log["title"]
                    });

                    this.fire("add", log);
                }.bind(this));

                this.$.localStorage.save();

                this.changeTo("current");
            },
            changeTo: function(log) {
                console.log("Changing log:", log);

                var logs = this.$.logs.children;
                for (var i = 0; i < logs.length; i++) {
                    logs[i].hidden = true;
                }

                var logElement = this.shadowRoot.querySelector("#log_" + log);
                logElement.hidden = false;
                this.currentLog = logElement;
            }
        });
    </script>
</polymer-element>
