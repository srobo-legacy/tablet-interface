<!--
`sr-power-output-controller` provides a controller for a power output.

Example:

    <sr-power-output-controller index="0"></sr-power-output-controller>

You can get the current state with the `state` attribute.

@group SR Power Elements
@element sr-power-output-controller
-->

<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="../wamp/index.html" />

<polymer-element name="sr-power-output-controller" attributes="index state readonly">
    <template>
        <style>
            :host {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 100px;

				margin: 5px;
                padding: 10px 0;
				border-radius: 10px;
            }

			:host(.checked) {
				background-color: rgb(13, 31, 97);
				color: white;
				font-weight: bold;
			}

            h2 {
                margin: 2px 0;
            }

            input[type=checkbox] {
                flex: 1 1 auto;
                margin: 2px 0;
                width: 32px;
                height: 32px;
            }
        </style>

        <h2>{{ index }}</h2>
        <input
            type="checkbox" checked="{{ state }}"
            on-change="{{ handleStateChange }}" disabled?="{{ readonly }}" />

        <core-localstorage
            id="localStorage"
            name="power_output_{{ index }}_state"></core-localstorage>

        <sr-wamp-core
            on-open="{{ handleWampOpen }}"
            on-close="{{ handleWampClose }}"></sr-wamp-core>
        <sr-wamp-call
            id="wampGetState"
            procedure="org.srobo.power.get_output_state"
            on-success="{{ handleGetStateSuccess }}"></sr-wamp-call>
        <sr-wamp-subscribe
            auto="wamp"
            topic="org.srobo.power.output_state"
            on-handle="{{ handleState }}"></sr-wamp-subscribe>
        <sr-wamp-publish
            id="publishValue"
            topic="org.srobo.power.output_state"></sr-wamp-publish>
        <sr-wamp-subscribe
            id="wampSubRobotState"
            auto="wamp"
            topic="org.srobo.state"
            on-handle="{{ handleRobotState }}"></sr-wamp-subscribe>
        <sr-wamp-call
            id="wampGetRobotState"
            procedure="org.srobo.state"
            on-success="{{ handleRobotState }}"></sr-wamp-call>
    </template>

    <script>
        Polymer("sr-power-output-controller", {
            index: 0,
            state: false,
            handleWampOpen: function() {
                this.readonly = false;
                this.$.wampGetState.go([this.index]);
                this.$.wampGetRobotState.go();
            },
            handleWampClose: function() {
                this.readonly = true;
                this.state = this.$.localStorage.value;
            },
            handleStateChange: function() {
                this.$.publishValue.go([this.index, this.state]);
				this.updateClass();
            },
            handleState: function(e) {
                var args = e.detail.args;
                if (args[0] === this.index) {
                    this.state = args[2];
                }
            },
            handleRobotState: function(e) {
                var state = e.detail.result || e.detail.args[0];
                if (state === "stopped") {
                    this.readonly = false;
                } else {
                    this.readonly = true;
                }
            },
            handleGetStateSuccess: function(e) {
                this.state = e.detail.result;
				this.updateClass();
            },
			updateClass: function() {
				if (this.state === true) {
					this.classList.add('checked');
				} else {
					this.classList.remove('checked');
				}
			},
            stateChanged: function(oldVal, newVal) {
                this.$.localStorage.value = newVal;
            }
        });
    </script>
</polymer-element>
