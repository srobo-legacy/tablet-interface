<!--
`sr-servos-servo-controller` provides a controller for an individual servo.

Example:

    <sr-servos-servo-controller
        board="abc"
        motor="0"></sr-servos-servo-controller>

You can get the current value with the `value` attribute.

@group SR Servos Elements
@element sr-servos-servo-controller
-->

<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="../wamp/index.html" />

<polymer-element name="sr-servos-servo-controller" attributes="board servo value">
    <template>
        <style>
            :host {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 100px;
            }

            input[type=range] {
                flex: 1 1 auto;
                -webkit-appearance: slider-vertical;
                writing-mode: bt-lr;
                margin: 16px 0;
            }

            h2 {
                margin: 2px 0;
            }

            span {
                margin: 2px 0 16px;
                font-size: 1.2em;
            }

            button {
                margin: 2px 0;
                padding: 4px 8px;
                font-weight: bold;
                font-size: 1.1em;
            }
        </style>

        <h2>{{ servo }}</h2>
        <input type="range" orient="vertical" min="0" max="100" step="0.01"
            value="{{ value }}" on-change="{{ handleValueChange }}" />
        <span>{{ value | formatValue }}</span>
        <button on-click="{{ handleReset }}">Reset</button>

        <core-localstorage
            id="localStorage"
            name="servos_{{ board }}_{{ servo }}_value"></core-localstorage>

        <sr-wamp-core
            on-open="{{ handleWampOpen }}"
            on-close="{{ handleWampClose }}"></sr-wamp-core>
        <sr-wamp-call
            id="wampGetServo"
            procedure="org.srobo.servos.get_servo"
            on-success="{{ handleGetServoSuccess }}"></sr-wamp-call>
        <sr-wamp-subscribe
            auto="wamp"
            topic="org.srobo.servos.servo_value"
            on-handle="{{ handleValue }}"></sr-wamp-subscribe>
        <sr-wamp-publish
            id="publishValue"
            topic="org.srobo.servos.servo_value"></sr-wamp-publish>
    </template>

    <script>
        Polymer("sr-servos-servo-controller", {
            board: 0,
            servo: 0,
            value: 50,
            handleWampOpen: function() {
                this.$.wampGetServo.go([this.board, this.servo]);
            },
            handleWampClose: function() {
                this.value = this.$.localStorage.value;
            },
            handleValueChange: function() {
                var args = [this.board, this.servo, parseFloat(this.value)];
                this.$.publishValue.go(args);
            },
            handleValue: function(e) {
                var args = e.detail.args;
                if (args[0] === this.board && args[1] === this.servo) {
                    this.value = parseFloat(args[2]);
                }
            },
            formatValue: function(v) {
                return Number(v).toFixed(2);
            },
            handleGetServoSuccess: function(e) {
                this.value = e.detail.result.value;
            },
            handleReset: function() {
                this.value = 50;
                this.$.publishValue.go([this.board, this.servo, 50]);
            },
            valueChanged: function(oldVal, newVal) {
                this.$.localStorage.value = newVal;
            }
        });
    </script>
</polymer-element>
