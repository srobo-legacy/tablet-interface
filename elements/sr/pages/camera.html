<!--
`sr-pages-camera` provides a page containing controls for viewing the image on
the camera and also libkoki marker information.

Example:

    <sr-core-page online="sr-pages-camera" offline="sr-pages-camera"></sr-core-page>

@group SR Pages Elements
@element sr-pages-camera
-->

<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="../wamp/index.html" />

<polymer-element name="sr-pages-camera">
    <template>
        <style>
            :host {
                flex: 1 1 auto;
                display: flex;
            }

            #current {
                flex: 1 1 auto;
                display: flex;
            }

            #old {
                flex: 0 0 auto;
                display: flex;
                flex-direction: column;
                overflow: auto;
                border-left: 1px solid black;
                width: 20%;
            }

            #current img {
                flex: 1 1 auto;
                object-fit: contain;
            }

            #old img {
                flex: 0 0 auto;
                margin-bottom: 1px;
                width: 100%;
                opacity: 0.5;
            }

            #old img.selected {
                opacity: 1;
            }
        </style>

        <sr-wamp-core id="wamp"></sr-wamp-core>

        <template bind if="{{ $.wamp.connected }}">
            <div id="current">
                <img id="image"></img>
            </div>

            <div id="old"></div>

            <sr-wamp-subscribe
                auto="wamp"
                topic="org.srobo.camera.image"
                on-handle="{{handleImage}}"></sr-wamp-subscribe>
        </template>

        <template bind if="{{ $.wamp.disconnected }}">
            <div flex horizontal center center-justified layout>
                <h1>You must be connected to the robot to view the camera.</h1>
            </div>
        </template>
    </template>

    <script>
        Polymer("sr-pages-camera", {
            deselectAll: function() {
                var old = this.shadowRoot.querySelector("#old");
                var imgs = old.children;
                for (var i = 0; i < imgs.length; i++) {
                    imgs[i].className = "";
                }
            },
            changeImage: function(img) {
                this.deselectAll();
                img.className = "selected";
                var image = this.shadowRoot.querySelector("#image");
                image.src = img.src;
            },
            addOldImage: function(src) {
                var old = this.shadowRoot.querySelector("#old");
                var img = document.createElement("img");
                img.src = src;
                img.onclick = this.changeImage.bind(this, img);
                if (old.children.length === 0) {
                    old.appendChild(img);
                } else {
                    old.insertBefore(img, old.children[0]);
                }
                return img;
            },
            handleImage: function(e) {
                var src = e.detail.args[0];
                var img = this.addOldImage(src);
                this.changeImage(img);
            }
        });
    </script>
</polymer-element>
