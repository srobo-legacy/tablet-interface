<!--
`sr-pages-servos` provides a page allowing you to control any servo connected
to the robot.

Example:

    <sr-core-page online="sr-pages-servos" offline="sr-pages-servos"></sr-core-page>

@group SR Pages Elements
@element sr-pages-servos
-->

<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="../core/index.html" />
<link rel="import" href="../servos/index.html" />
<link rel="import" href="../wamp/index.html" />

<polymer-element name="sr-pages-servos">
    <template>
        <style>
            :host {
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
            }

            #controllers {
                flex: 1 1 auto;
                display: flex;
            }

            sr-servos-board-controller {
                flex: 1 1 auto;
            }
        </style>

        <sr-ui-toolbar id="toolbar">
            <h1 flex>Servo controllers</h1>
        </sr-ui-toolbar>

        <sr-wamp-core id="wamp"></sr-wamp-core>

        <template bind if="{{ $.wamp.connected }}">
            <div id="controllers"></div>

            <sr-wamp-call
                auto="wamp"
                procedure="org.srobo.servos.all_boards"
                on-success="{{ handleAllBoardsSuccess }}"></sr-wamp-call>
        </template>

        <template bind if="{{ $.wamp.disconnected }}">
            <div flex horizontal center center-justified layout>
                <h1>You must be connected to the robot to control the servos.</h1>
            </div>
        </template>
    </template>

    <script>
        Polymer("sr-pages-servos", {
            changeBoard: function(serialNumber) {
                var divs = this.shadowRoot.querySelectorAll("sr-servos-board-controller");
                for (var i = 0; i < divs.length; i++) {
                    divs[i].hidden = true;
                }
                this.shadowRoot.querySelector("#board_" + serialNumber).hidden = false;
            },
            _createController: function(serialNumber) {
                var div = document.createElement("sr-servos-board-controller");
                div.id = "board_" + serialNumber;
                div.board = serialNumber;
                return div;
            },
            _createButton: function(serialNumber) {
                var button = document.createElement("button");
                button.textContent = "Board " + serialNumber;
                button.onclick = this.changeBoard.bind(this, serialNumber);
                return button;
            },
            handleAllBoardsSuccess: function(e) {
                var boards = e.detail.result;
                for (var serialNumber in boards) {
                    var button = this._createButton(serialNumber);
                    this.$.toolbar.appendChild(button);
                    var controller = this._createController(serialNumber);
                    var controllers = this.shadowRoot.querySelector("#controllers");
                    controllers.appendChild(controller);
                }

                this.changeBoard(Object.keys(boards)[0]);
            }
        });
    </script>
</polymer-element>
