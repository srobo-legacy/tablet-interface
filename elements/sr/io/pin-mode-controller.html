<!--
`sr-io-pin-mode-controller` provides a pin controller for the mode of a pin.

Example:

    <sr-io-digital-pin-controller
        board="abc"
        pin="0"
        value="input"></sr-io-digital-pin-controller>

Generally, you will want to use `sr-io-pin-controller` which includes a pin
mode controller.

@group SR I/O Elements
@element sr-io-pin-mode-controller
-->

<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="/bower_components/core-localstorage/core-localstorage.html" />
<link rel="import" href="../wamp/index.html" />

<polymer-element name="sr-io-pin-mode-controller" attributes="board pin value">
    <template>
        <style>
            :host {
                display: block;
            }

            select {
                padding: 2px;
                width: 100%;
            }
        </style>

        <select value="{{ value }}" on-change="{{ handleValueChange }}">
            <option value="input" selected>Input</option>
            <option value="output">Output</option>
            <option value="input_pullup">Input Pull-up</option>
        </select>

        <core-localstorage
            id="localStorage"
            name="io_{{ board }}_{{ pin }}_mode"></core-localstorage>

        <sr-wamp-core
            id="wamp"
            on-open="{{ handleWampOpen }}"
            on-close="{{ handleWampClose }}"></sr-wamp-core>
        <sr-wamp-subscribe
            auto="wamp"
            topic="org.srobo.ruggeduinos.pin_mode"
            on-handle="{{ handleValue }}"></sr-wamp-subscribe>
        <sr-wamp-publish
            id="publishValue"
            topic="org.srobo.ruggeduinos.pin_mode"></sr-wamp-publish>
    </template>

    <script>
        Polymer("sr-io-pin-mode-controller", {
            board: 0,
            pin: 0,
            value: null,
            handleWampOpen: function() {
                // the 'auto' attributes will do this for me
            },
            handleWampClose: function() {
                this.value = this.$.localStorage.value;
            },
            handleValueChange: function() {
                this.$.publishValue.go([this.board, this.pin, this.value]);
            },
            handleValue: function(e) {
                var args = e.detail.args;
                if (args[0] === this.board && args[1] === this.pin) {
                    this.value = args[2];
                }
            },
            valueChanged: function() {
                this.$.localStorage.value = this.value;
            }
        });
    </script>
</polymer-element>
