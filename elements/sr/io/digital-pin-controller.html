<!--
`sr-io-digital-pin-controller` provides a pin controller for a digital pin.

Example:

    <sr-io-digital-pin-controller
        board="abc"
        pin="0"
        mode="input"
        value="1"></sr-io-digital-pin-controller>

Generally, you will want to use `sr-io-pin-controller` which handles the
difference between an analogue and digital pin automatically.

@group SR I/O Elements
@element sr-io-digital-pin-controller
-->

<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="../wamp/index.html" />

<polymer-element name="sr-io-digital-pin-controller" attributes="board pin mode value">
    <template>
        <style>
            :host {
                display: block;
            }

            input {
                padding: 2px;
                width: 32px;
                height: 32px;
            }
        </style>

        <input
            checked="{{ value }}"
            on-change="{{ handleValueChange }}"
            type="checkbox"
            disabled?="{{ !isInput }}" />

        <core-localstorage
            id="localStorage"
            name="io_{{ board }}_{{ pin }}_value"></core-localstorage>

        <sr-wamp-core
            id="wamp"
            on-open="{{ handleWampOpen }}"
            on-close="{{ handleWampClose }}"></sr-wamp-core>
        <sr-wamp-subscribe
            auto="wamp"
            topic="org.srobo.ruggeduinos.pin_value"
            on-handle="{{ handleValue }}"></sr-wamp-subscribe>
        <sr-wamp-publish
            id="publishValue"
            topic="org.srobo.ruggeduinos.pin_value"></sr-wamp-publish>
    </template>

    <script>
        Polymer("sr-io-digital-pin-controller", {
            board: 0,
            pin: 0,
            mode: undefined,
            value: false,
            isInput: false,
            handleWampOpen: function() {
                // nothing to do here since 'auto' attributes do the work
            },
            handleWampClose: function() {
                this.value = this.$.localStorage.value;
            },
            modeChanged: function() {
                if (typeof(this.mode) === "string") {
                    this.isInput = this.mode.indexOf("input") === 0;
                } else {
                    this.isInput = false;
                }
            },
            handleValueChange: function() {
                this.$.publishValue.go([this.board, this.pin, this.value]);
            },
            handleValue: function(e) {
                var args = e.detail.args;
                if (args[0] === this.board && args[1] === this.pin) {
                    this.value = args[2];
                }
            },
            valueChanged: function() {
                this.$.localStorage.value = this.value;
            }
        });
    </script>
</polymer-element>
