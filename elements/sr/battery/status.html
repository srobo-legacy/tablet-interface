<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="../wamp/index.html" />

<polymer-element name="sr-battery-status" attributes="level">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
                z-index: 1000;
            }
        </style>

        <svg
            xmlns="http://www.w3.org/2000/svg"
            version="1.1"
            width="25"
            height="80"
            viewBox="0 0 25 66">
            <g>
                <clipPath id="progressClip">
                    <rect
                        width="25"
                        height="{{ level * 53 }}"
                        x="0"
                        y="{{ ((1 - level) * 53) + 9 }}" />
                </clipPath>
                <rect
                    id="progressRect"
                    width="17"
                    height="53"
                    rx="2"
                    ry="2"
                    x="4"
                    y="9"
                    clip-path="url(#progressClip)"
                    style="fill:rgb(255, {{ level*255 | floor }}, {{ level*255 | floor }})" />
                <path
                    d="M 9,0 C 7.338,0 6,1.338 6,3 L 6,5 3,5 C 1.338,5 0,6.338 0,8 l 0,55 c 0,1.662 1.338,3 3,3 l 19,0 c 1.662,0 3,-1.338 3,-3 L 25,8 C 25,6.338 23.630008,5 22,5 L 19,5 19,3 C 19,1.338 17.662,0 16,0 z m -4.5,7.5 1.90625,0 12.1875,0 1.90625,0 c 1.108,0 2,0.892 2,2 l 0,52 c 0,1.108 -0.892,2 -2,2 l -16,0 c -1.108,0 -2,-0.892 -2,-2 l 0,-52 c 0,-1.108 0.892,-2 2,-2 z"
                    style="fill: white" />
                <text
                    id="questionMark"
                    x="6"
                    y="46"
                    style="fill: white; font-size: 1.9em;">?</text>
            </g>
        </svg>

        <sr-wamp-core
            on-open="{{ handleOpen }}"
            on-close="{{ handleClose }}" />
        <sr-wamp-call
            auto="wamp"
            procedure="org.srobo.battery.level"
            on-success="{{ handleBatteryLevel }}"></sr-wamp-call>
        <sr-wamp-subscribe
            auto="wamp"
            topic="org.srobo.battery.level"
            on-handle="{{ handleBatteryLevel }}"></sr-wamp-subscribe>
    </template>

    <script>
        Polymer("sr-battery-status", {
            level: 1.0,
            handleOpen: function() {
                this.$.questionMark.style.display = "none";
                this.$.progressRect.style.display = "block";
            },
            handleClose: function() {
                this.$.questionMark.style.display = "block";
                this.$.progressRect.style.display = "none";
            },
            handleBatteryLevel: function(e) {
                if (e.detail.result !== undefined) {
                    this.level = e.detail.result;
                } else {
                    this.level = e.detail.args[0];
                }
            },
            floor: function(value) {
                return Math.floor(value);
            }
        });
    </script>
</polymer-element>
