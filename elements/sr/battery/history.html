<!--
`sr-battery-history` provides a graph containing the level of the battery
compared with time.

Example:

    <sr-battery-history></sr-battery-history>

You can force a new data point to be added to the graph by setting the
write-only `level` attribute.

Example:

    var element = document.querySelector("sr-battery-history");
    element.level = 1;
    // ... wait 5 seconds ...
    element.level = 0.5;
    // ... wait 5 seconds ...
    element.level = 0;

**Note:** due to issues with the `chart.js` library, the graph itself is
restricted to a size of 660x300 (which happens to fit nicely on the tablet
screen) and will end up centred inside the element.

@group SR Battery Elements
@element sr-battery-history
-->

<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="../wamp/index.html" />

<polymer-element name="sr-battery-history" attributes="level">
    <template>
        <style>
            :host {
                display: flex;
                justify-content: center;
            }

            canvas {
                align-self: center;
            }
        </style>

        <canvas id="canvas" width="660" height="300"></canvas>

        <sr-wamp-call
            auto="wamp"
            procedure="org.srobo.battery.level"
            on-success="{{ handleBatteryLevel }}"></sr-wamp-call>
        <sr-wamp-subscribe
            topic="org.srobo.battery.level"
            on-handle="{{ handleBatteryLevel }}"></sr-wamp-subscribe>
    </template>

    <script src="chart.js"></script>
    <script src="moment.js"></script>

    <script>
        Polymer("sr-battery-history", {
            _lastTime: new Date(),
            levelChanged: function() {
                var timeStr = moment().format("HH:mm:ss");

                if (!this.chart) {
                    var data = {
                        labels: [timeStr, timeStr],
                        datasets: [
                            {
                                label: "Battery Level",
                                fillColor: "rgba(151,187,205,0.2)",
                                strokeColor: "rgba(151,187,205,1)",
                                pointColor: "rgba(151,187,205,1)",
                                pointStrokeColor: "#fff",
                                pointHighlightFill: "#fff",
                                pointHighlightStroke: "rgba(151,187,205,1)",
                                data: [this.level, this.level]
                            }
                        ]
                    };
                    var options = {};
                    this.ctx = this.$.canvas.getContext("2d");
                    this.chart = new Chart(this.ctx).Line(data, options);
                }

                var diff = parseInt((new Date() - this._lastTime) / 1000);
                if (diff >= 59) {
                    this.chart.addData([this.level], timeStr);
                    this._lastTime = new Date();
                }
            },
            handleBatteryLevel: function(e) {
                if (e.detail.result !== undefined) {
                    this.level = e.detail.result;
                } else {
                    this.level = e.detail.args[0];
                }
            }
        });
    </script>
</polymer-element>
