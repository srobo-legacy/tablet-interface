<link rel="import" href="/bower_components/polymer/polymer.html" />

<polymer-element name="sr-core-wamp">
    <template>
        <style>
            :host {
                display: none;
            }
        </style>
    </template>

    <script src="autobahn.min.js"></script>

    <script>
        (function() {
            var _session;
            var _connection = new autobahn.Connection({
                url: "ws://" + location.hostname + ":9000",
                realm: "srobo"
            });

            _connection.onopen = function(session) {
                _session = session;
                console.log("Opened connection to WAMP server.");
                window.dispatchEvent(new CustomEvent("sr-wamp-open"));
            };

            _connection.onclose = function(e) {
                console.log("Closed connection to WAMP server.", e);
                window.dispatchEvent(new CustomEvent("sr-wamp-close"));
                window.location.reload();
            };

            window.addEventListener("polymer-ready", function() {
                console.log("Connecting to WAMP server.");
                _connection.open();
            });

            Polymer("sr-core-wamp", {
                created: function() {
                    window.addEventListener("sr-wamp-open", this.onOpen.bind(this));
                    window.addEventListener("sr-wamp-close", this.onClose.bind(this));
                },
                domReady: function() {
                    if (_connection.isOpen) {
                        this.onOpen();
                    }
                },
                subscribe: function(topic, handler, options, callback) {
                    console.log("Subscribing to:", topic);
                    this.session.subscribe(topic, handler, options).then(
                        function(subscription) {
                            if (callback !== undefined) {
                                callback(subscription);
                            }
                        },
                        function(error) {
                            console.log("Subscription failed!", error);
                        }
                    )
                },
                unsubscribe: function(subscription, callback) {
                    console.log("Unsubscribing from:", subscription.topic);
                    this.session.unsubscribe(subscription).then(
                        function() {
                            if (callback !== undefined) {
                                callback(subscription);
                            }
                        },
                        function(error) {
                            console.log("Unsubscription failed!", error);
                        }
                    )
                },
                publish: function(topic, args, kwargs, options) {
                    console.log("Publishing:", topic, args, kwargs, options);
                    return this.session.publish(topic, args, kwargs, options);
                },
                call: function(procedure, args, kwargs, options) {
                    console.log("Calling:", procedure, args, kwargs, options);
                    return this.session.call(procedure, args, kwargs, options);
                },
                onOpen: function() {
                    this.fire("open");
                },
                onClose: function() {
                    this.fire("close");
                },
                get connection() {
                    return _connection;
                },
                get session() {
                    return _session;
                }
            });
        }());
    </script>
</polymer-element>

<polymer-element name="sr-core-wamp-subscribe" attributes="topic auto">
    <template>
        <style>
            :host {
                display: none;
            }
        </style>

        <sr-core-wamp
            id="wamp"
            on-open="{{handleOpen}}"></sr-core-wamp>
    </template>

    <script>
        Polymer("sr-core-wamp-subscribe", {
            auto: "wamp",
            subscribe: function() {
                this.$.wamp.subscribe(
                    this.topic,
                    function(args, kwargs, details) {
                        this.fire("handle", {
                            args: args, kwargs: kwargs, details: details
                        });
                    }.bind(this),
                    undefined,
                    function(subscription) {
                        this._subscription = subscription;
                    }.bind(this)
                );
            },
            unsubscribe: function() {
                this.$.wamp.unsubscribe(this._subscription);
            },
            handleOpen: function() {
                if (this.auto === "wamp") {
                    this.subscribe();
                }
            },
            onPageShow: function() {
                if (this.auto === "page") {
                    this.subscribe();
                }
            },
            onPageHide: function() {
                if (this.auto === "page") {
                    this.unsubscribe();
                }
            }
        });
    </script>
</polymer-element>

<polymer-element name="sr-core-wamp-publish" attributes="topic">
    <template>
        <style>
            :host {
                display: none;
            }
        </style>

        <sr-core-wamp id="wamp"></sr-core-wamp>
    </template>

    <script>
        Polymer("sr-core-wamp-publish", {
            go: function(args, kwargs, options) {
                return this.$.wamp.publish(this.topic, args, kwargs, options);
            }
        });
    </script>
</polymer-element>

<polymer-element name="sr-core-wamp-call" attributes="procedure args kwargs options auto">
    <template>
        <style>
            :host {
                display: none;
            }
        </style>

        <sr-core-wamp
            id="wamp"
            on-open="{{handleOpen}}"></sr-core-wamp>
    </template>

    <script>
        Polymer("sr-core-wamp-call", {
            auto: null,
            handleOpen: function() {
                if (this.auto === "wamp") {
                    this.go();
                }
            },
            onPageShow: function() {
                if (this.auto === "page") {
                    this.go();
                }
            },
            go: function(args, kwargs, options) {
                this.$.wamp.call(this.procedure, args, kwargs, options).then(function(result) {
                    this.fire("success", {result: result});
                }.bind(this));
            }
        });
    </script>
</polymer-element>
