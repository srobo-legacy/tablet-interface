<link rel="import" href="/bower_components/polymer/polymer.html" />
<link rel="import" href="/bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../sr-mode-picker/index.html" />
<link rel="import" href="../sr-pages/index.html" />
<link rel="import" href="../sr-zone-picker/index.html" />

<polymer-element name="sr-page-setup" attributes="disabled" extends="sr-page">
    <template>
        <style>
            #first {
                margin: 10px;
                flex: 1 1 auto;
                align-self: center;
                justify-content: center;
            }

            #overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.95);
                display: none;
                flex-direction: column;
                align-self: center;
                justify-content: center;
            }

            #overlay.disabled {
                display: flex;
            }

            #overlay > h1 {
                align-self: center;
                font-size: 3em;
                font-weight: bold;
            }

            #overlay > p {
                align-self: center;
                font-size: 1.2em;
            }

            .col1 {
                display: inline-block;
                min-width: 100px;
                text-align: right;
                margin-right: 12px;
            }
        </style>

        <sr-toolbar>
            <h1>Set up your robot</h1>
        </sr-toolbar>

        <div id="first" vertical center layout>
            <div horizontal start layout>
                <div vertical center layout style="margin: 0 20px;">
                    <sr-zone-picker id="zonePicker"></sr-zone-picker>
                    <h2>Zone</h2>
                </div>

                <div vertical center layout style="margin: 0 20px;">
                    <sr-mode-picker id="modePicker"></sr-mode-picker>
                    <h2>Mode</h2>
                </div>
            </div>
        </div>

        <div id="overlay" class="{{ {disabled: disabled} | tokenList }}">
            <h1>Project runningâ€¦</h1>
            <p>
                <span class="col1">Mode</span><strong>{{$.modePicker.mode === "dev" ? "Development" : "Competition"}}</strong><br />
                <span class="col1">Zone</span><strong>{{$.zonePicker.zone}}</strong><br />
                <span class="col1">Project</span><strong>{{project.name}}</strong> @ <strong>{{project.version}}</strong><br />
                <span class="col1">Pyenv</span><strong>v{{pyenv.version}}</strong>
            </p>
        </div>

        <sr-wamp
            on-open="{{handleOpen}}"></sr-wamp>
        <sr-wamp-subscribe
            topic="org.srobo.state"
            on-handle="{{handleState}}"></sr-wamp-subscribe>
        <sr-wamp-subscribe
            topic="org.srobo.project.name"
            on-handle="{{handleProjectName}}"></sr-wamp-subscribe>
        <sr-wamp-subscribe
            topic="org.srobo.project.version"
            on-handle="{{handleProjectVersion}}"></sr-wamp-subscribe>
        <sr-wamp-subscribe
            topic="org.srobo.pyenv.version"
            on-handle="{{handlePyenvVersion}}"></sr-wamp-subscribe>
        <sr-wamp-call
            id="stateCall"
            procedure="org.srobo.state"
            on-success="{{handleState}}"></sr-wamp-call>
        <sr-wamp-call
            id="pyenvCall"
            procedure="org.srobo.pyenv.version"
            on-success="{{handlePyenvVersion}}"></sr-wamp-call>
        <sr-wamp-call
            id="projectVersionCall"
            procedure="org.srobo.project.version"
            on-success="{{handleProjectVersion}}"></sr-wamp-call>
        <sr-wamp-call
            id="projectNameCall"
            procedure="org.srobo.project.name"
            on-success="{{handleProjectName}}"></sr-wamp-call>
    </template>

    <script>
        Polymer("sr-page-setup", {
            name: "setup",
            disabled: false,
            created: function() {
                this.project = {}
                this.pyenv = {};
            },
            handleOpen: function() {
                this.$.stateCall.go();
                this.$.pyenvCall.go();
                this.$.projectVersionCall.go();
                this.$.projectNameCall.go();
            },
            handleState: function(e) {
                var state = e.detail.result || e.detail.args[0];
                this.disabled = state !== "stopped";
            },
            handleProjectName: function(e) {
                this.project.name = e.detail.result || e.detail.args[0];
            },
            handleProjectVersion: function(e) {
                this.project.version = e.detail.result || e.detail.args[0];
            },
            handlePyenvVersion: function(e) {
                this.pyenv.version = e.detail.result || e.detail.args[0];
            }
        });
    </script>
</polymer-element>
